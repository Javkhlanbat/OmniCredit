<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OmniCredit ‚Äî Admin Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/navigation.css">
  <link rel="stylesheet" href="css/buttons.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/footer.css">

  <style>
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 48px 0;
      margin: -32px 0 32px;
      color: white;
      text-align: center;
    }

    .admin-tabs {
      display: flex;
      gap: 8px;
      margin: 32px 0;
      border-bottom: 2px solid var(--line);
      overflow-x: auto;
    }

    .admin-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-muted);
      transition: var(--transition);
      white-space: nowrap;
    }

    .admin-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .admin-tab:hover {
      color: var(--text);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
      margin: 32px 0;
    }

    .admin-stats-card {
      background: var(--card);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }

    .admin-stats-card h3 {
      font-size: 2rem;
      margin: 8px 0;
      background: var(--gradient-peachy);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .admin-stats-card p {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .data-table {
      width: 100%;
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .data-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background: var(--bg);
      padding: 16px;
      text-align: left;
      font-weight: 700;
      font-size: 0.875rem;
      color: var(--text-muted);
      border-bottom: 2px solid var(--line);
    }

    .data-table td {
      padding: 16px;
      border-bottom: 1px solid var(--line);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover {
      background: var(--bg);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-pending {
      background: #FFF4E6;
      color: #F59E0B;
    }

    .status-approved {
      background: #DFFFD8;
      color: #10b981;
    }

    .status-rejected {
      background: #FFE6E6;
      color: #EF4444;
    }

    .status-active {
      background: #E0F2FE;
      color: #0284C7;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      padding: 8px 12px;
      font-size: 0.875rem;
    }

    .search-box {
      margin: 24px 0;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .search-box input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--line);
      border-radius: var(--radius);
      font-size: 1rem;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--primary);
    }

    @media (max-width: 768px) {
      .data-table {
        overflow-x: auto;
      }

      .admin-tabs {
        padding-bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <div class="brand">OmniCredit Admin</div>
      <div class="nav-links">
        <a href="index.html">–ù“Ø“Ø—Ä</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="admin.html" class="active">Admin</a>
      </div>
      <div class="auth-buttons">
        <a href="profile.html" class="btn btn-ghost btn-sm">–ü—Ä–æ—Ñ–∞–π–ª</a>
        <button class="btn btn-primary btn-sm" onclick="handleLogout()">–ì–∞—Ä–∞—Ö</button>
      </div>
      <button class="mobile-menu-toggle">‚ò∞</button>
    </nav>

    <div class="admin-header">
      <h1>Admin Dashboard</h1>
      <p style="opacity: 0.9; margin-top: 8px;">–°–∏—Å—Ç–µ–º–∏–π–Ω —É–¥–∏—Ä–¥–ª–∞–≥—ã–Ω —Å–∞–º–±–∞—Ä</p>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-grid">
      <div class="admin-stats-card">
        <p>–ù–∏–π—Ç —Ö—ç—Ä—ç–≥–ª—ç–≥—á</p>
        <h3 id="totalUsers">0</h3>
      </div>
      <div class="admin-stats-card">
        <p>–•“Ø–ª—ç—ç–≥–¥—ç–∂ –±—É–π —Ö“Ø—Å—ç–ª—Ç</p>
        <h3 id="pendingLoans">0</h3>
      </div>
      <div class="admin-stats-card">
        <p>–ò–¥—ç–≤—Ö—Ç—ç–π –∑—ç—ç–ª</p>
        <h3 id="activeLoans">0</h3>
      </div>
      <div class="admin-stats-card">
        <p>–ù–∏–π—Ç –∑—ç—ç–ª–∏–π–Ω –¥“Ø–Ω</p>
        <h3 id="totalLoanAmount">‚ÇÆ0</h3>
      </div>
    </div>

    <!-- Tabs -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('loans')">–ó—ç—ç–ª–∏–π–Ω —Ö“Ø—Å—ç–ª—Ç</button>
      <button class="admin-tab" onclick="switchTab('users')">–•—ç—Ä—ç–≥–ª—ç–≥—á–∏–¥</button>
      <button class="admin-tab" onclick="switchTab('payments')">–¢”©–ª–±”©—Ä</button>
      <button class="admin-tab" onclick="switchTab('settings')">–¢–æ—Ö–∏—Ä–≥–æ–æ</button>
    </div>

    <!-- Loans Tab -->
    <div id="loans-tab" class="tab-content active">
      <div class="search-box">
        <input type="text" placeholder="–•–∞–π—Ö (ID, –Ω—ç—Ä, –¥“Ø–Ω)..." id="loanSearch" onkeyup="filterLoans()">
        <select class="btn btn-secondary" id="loanStatusFilter" onchange="filterLoans()">
          <option value="all">–ë“Ø—Ö —Ç”©–ª”©–≤</option>
          <option value="pending">–•“Ø–ª—ç—ç–≥–¥—ç–∂ –±—É–π</option>
          <option value="approved">–ó”©–≤—à”©”©—Ä”©–≥–¥—Å”©–Ω</option>
          <option value="rejected">–¢–∞—Ç–≥–∞–ª–∑—Å–∞–Ω</option>
          <option value="active">–ò–¥—ç–≤—Ö—Ç—ç–π</option>
        </select>
      </div>

      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>–•—ç—Ä—ç–≥–ª—ç–≥—á</th>
              <th>–î“Ø–Ω</th>
              <th>–•—É–≥–∞—Ü–∞–∞</th>
              <th>–¢”©–ª”©–≤</th>
              <th>–û–≥–Ω–æ–æ</th>
              <th>“Æ–π–ª–¥—ç–ª</th>
            </tr>
          </thead>
          <tbody id="loansTableBody">
            <tr>
              <td colspan="7" style="text-align: center; padding: 48px; color: var(--text-muted);">
                –ê—á–∞–∞–ª–ª–∞–∂ –±–∞–π–Ω–∞...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
      <div class="search-box">
        <input type="text" placeholder="–ù—ç—Ä, –∏-–º—ç–π–ª, —É—Ç–∞—Å, —Ä–µ–≥–∏—Å—Ç—Ä—ç—ç—Ä —Ö–∞–π—Ö..." id="userSearch" onkeyup="filterUsers()">
      </div>

      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>–ù—ç—Ä</th>
              <th>–ò-–º—ç–π–ª</th>
              <th>–£—Ç–∞—Å</th>
              <th>–†–µ–≥–∏—Å—Ç—Ä</th>
              <th>–ë“Ø—Ä—Ç–≥—ç—Å—ç–Ω –æ–≥–Ω–æ–æ</th>
              <th>“Æ–π–ª–¥—ç–ª</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="7" style="text-align: center; padding: 48px; color: var(--text-muted);">
                –ê—á–∞–∞–ª–ª–∞–∂ –±–∞–π–Ω–∞...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="payments-tab" class="tab-content">
      <div class="search-box">
        <input type="text" placeholder="–¢”©–ª–±”©—Ä —Ö–∞–π—Ö..." id="paymentSearch" onkeyup="filterPayments()">
      </div>

      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>–ó—ç—ç–ª–∏–π–Ω ID</th>
              <th>–•—ç—Ä—ç–≥–ª—ç–≥—á</th>
              <th>–î“Ø–Ω</th>
              <th>–û–≥–Ω–æ–æ</th>
              <th>–¢”©–ª”©–≤</th>
            </tr>
          </thead>
          <tbody id="paymentsTableBody">
            <tr>
              <td colspan="6" style="text-align: center; padding: 48px; color: var(--text-muted);">
                –¢”©–ª–±”©—Ä–∏–π–Ω —Ç“Ø“Ø—Ö –æ–¥–æ–æ–≥–æ–æ—Ä –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <div class="card">
        <div class="card-body">
          <h3>–°–∏—Å—Ç–µ–º–∏–π–Ω —Ç–æ—Ö–∏—Ä–≥–æ–æ</h3>
          <p style="color: var(--text-muted); margin: 16px 0;">–ó—ç—ç–ª–∏–π–Ω “Ø–Ω–¥—Å—ç–Ω —Ç–æ—Ö–∏—Ä–≥–æ–æ</p>

          <div style="margin: 24px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">–•“Ø“Ø–≥–∏–π–Ω —Ö—É–≤—å (%)</label>
            <input type="number" class="btn btn-secondary" style="width: 100%; padding: 12px;" placeholder="1.5" value="1.5">
          </div>

          <div style="margin: 24px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">–•–∞–º–≥–∏–π–Ω –∏—Ö –∑—ç—ç–ª–∏–π–Ω –¥“Ø–Ω (‚ÇÆ)</label>
            <input type="number" class="btn btn-secondary" style="width: 100%; padding: 12px;" placeholder="10000000" value="10000000">
          </div>

          <div style="margin: 24px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">–•–∞–º–≥–∏–π–Ω –±–∞–≥–∞ –∑—ç—ç–ª–∏–π–Ω –¥“Ø–Ω (‚ÇÆ)</label>
            <input type="number" class="btn btn-secondary" style="width: 100%; padding: 12px;" placeholder="100000" value="100000">
          </div>

          <button class="btn btn-primary btn-lg" onclick="saveSettings()">–•–∞–¥–≥–∞–ª–∞—Ö</button>
        </div>
      </div>
    </div>

  </div>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <div class="footer-brand">OmniCredit</div>
          <p>–ú–æ–Ω–≥–æ–ª—ã–Ω —Ö–∞–º–≥–∏–π–Ω —Ö—è–ª–±–∞—Ä –±”©–≥”©”©–¥ –Ω–∞–π–¥–≤–∞—Ä—Ç–∞–π –∑—ç—ç–ª–∏–π–Ω “Ø–π–ª—á–∏–ª–≥—ç—ç.</p>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="footer-copyright">
          <span>¬© 2025 OmniCredit. –ë“Ø—Ö —ç—Ä—Ö —Ö—É—É–ª–∏–∞—Ä —Ö–∞–º–≥–∞–∞–ª–∞–≥–¥—Å–∞–Ω.</span>
        </div>
      </div>
    </div>
  </footer>

  <script src="js/utils.js"></script>
  <script src="js/navigation.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth-guard.js"></script>
  <script>
    let allLoans = [];
    let allUsers = [];
    let allPayments = [];

    // Logout handler
    function handleLogout() {
      if (confirm('–ì–∞—Ä–∞—Ö–¥–∞–∞ –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?')) {
        AuthAPI.logout();
      }
    }

    // Tab switching
    function switchTab(tabName) {
      // Remove active class from all tabs
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Remove active class from all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // Add active class to clicked tab
      event.target.classList.add('active');

      // Show corresponding content
      document.getElementById(tabName + '-tab').classList.add('active');

      // Load data based on tab
      if (tabName === 'loans') loadLoans();
      else if (tabName === 'users') loadUsers();
      else if (tabName === 'payments') loadPayments();
    }

    // Load statistics
    async function loadStatistics() {
      try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');

        // Load all loans
        const response = await fetch('http://localhost:5000/api/loans/admin/all', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();
        const loans = data.loans || [];

        // Load all users
        const usersResponse = await fetch('http://localhost:5000/api/auth/admin/users', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const userData = await usersResponse.json();
        const users = userData.users || [];

        // Calculate statistics
        const pendingLoans = loans.filter(l => l.status === 'pending').length;
        const activeLoans = loans.filter(l => l.status === 'active' || l.status === 'approved').length;
        const totalAmount = loans.reduce((sum, l) => sum + (l.amount || 0), 0);

        // Update UI
        document.getElementById('totalUsers').textContent = users.length;
        document.getElementById('pendingLoans').textContent = pendingLoans;
        document.getElementById('activeLoans').textContent = activeLoans;
        document.getElementById('totalLoanAmount').textContent = `‚ÇÆ${totalAmount.toLocaleString()}`;

      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // Load loans
    async function loadLoans() {
      try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        const response = await fetch('http://localhost:5000/api/loans/admin/all', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || errorData.error || '–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞');
        }

        const data = await response.json();
        allLoans = data.loans || [];
        displayLoans(allLoans);
      } catch (error) {
        console.error('Error loading loans:', error);
        document.getElementById('loansTableBody').innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 48px; color: #EF4444;">
              –ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Display loans
    function displayLoans(loans) {
      const tbody = document.getElementById('loansTableBody');

      if (!loans || loans.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 48px; color: var(--text-muted);">
              –ó—ç—ç–ª–∏–π–Ω —Ö“Ø—Å—ç–ª—Ç –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = loans.map(loan => {
        const statusClass = `status-${loan.status}`;
        const statusText = {
          'pending': '–•“Ø–ª—ç—ç–≥–¥—ç–∂ –±—É–π',
          'approved': '–ó”©–≤—à”©”©—Ä”©–≥–¥—Å”©–Ω',
          'rejected': '–¢–∞—Ç–≥–∞–ª–∑—Å–∞–Ω',
          'active': '–ò–¥—ç–≤—Ö—Ç—ç–π'
        }[loan.status] || loan.status;

        const date = new Date(loan.created_at).toLocaleDateString('mn-MN');

        return `
          <tr>
            <td>#${loan.id}</td>
            <td>${loan.user_id}</td>
            <td style="font-weight: 700;">‚ÇÆ${loan.amount.toLocaleString()}</td>
            <td>${loan.term} —Å–∞—Ä</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${date}</td>
            <td>
              <div class="action-buttons">
                ${loan.status === 'pending' ? `
                  <button class="btn btn-primary btn-icon" onclick="approveLoan(${loan.id})">Approve</button>
                  <button class="btn btn-secondary btn-icon" onclick="rejectLoan(${loan.id})">Reject</button>
                ` : `
                  <button class="btn btn-secondary btn-icon" onclick="viewLoanDetails(${loan.id})">View</button>
                `}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Filter loans
    function filterLoans() {
      const searchTerm = document.getElementById('loanSearch').value.toLowerCase();
      const statusFilter = document.getElementById('loanStatusFilter').value;

      let filtered = allLoans;

      // Filter by status
      if (statusFilter !== 'all') {
        filtered = filtered.filter(loan => loan.status === statusFilter);
      }

      // Filter by search term
      if (searchTerm) {
        filtered = filtered.filter(loan =>
          loan.id.toString().includes(searchTerm) ||
          loan.user_id.toString().includes(searchTerm) ||
          loan.amount.toString().includes(searchTerm)
        );
      }

      displayLoans(filtered);
    }

    // Approve loan
    async function approveLoan(loanId) {
      if (!confirm('–≠–Ω—ç –∑—ç—ç–ª–∏–π–≥ –∑”©–≤—à”©”©—Ä”©—Ö “Ø“Ø?')) return;

      try {
        const response = await fetch(`http://localhost:5000/api/loans/admin/${loanId}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'approved' })
        });

        if (response.ok) {
          alert('–ó—ç—ç–ª –∞–º–∂–∏–ª—Ç—Ç–∞–π –∑”©–≤—à”©”©—Ä”©–≥–¥–ª”©”©');
          loadLoans();
          loadStatistics();
        } else {
          const error = await response.json();
          alert('–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ' + (error.message || '–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π –∞–ª–¥–∞–∞'));
        }
      } catch (error) {
        console.error('Error approving loan:', error);
        alert('–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ' + error.message);
      }
    }

    // Reject loan
    async function rejectLoan(loanId) {
      if (!confirm('–≠–Ω—ç –∑—ç—ç–ª–∏–π–≥ —Ç–∞—Ç–≥–∞–ª–∑–∞—Ö —É—É?')) return;

      try {
        const response = await fetch(`http://localhost:5000/api/loans/admin/${loanId}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'rejected' })
        });

        if (response.ok) {
          alert('–ó—ç—ç–ª —Ç–∞—Ç–≥–∞–ª–∑–∞–≥–¥–ª–∞–∞');
          loadLoans();
          loadStatistics();
        } else {
          const error = await response.json();
          alert('–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ' + (error.message || '–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π –∞–ª–¥–∞–∞'));
        }
      } catch (error) {
        console.error('Error rejecting loan:', error);
        alert('–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ' + error.message);
      }
    }

    // View loan details
    function viewLoanDetails(loanId) {
      alert(`–ó—ç—ç–ª–∏–π–Ω –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª #${loanId}\n\n–≠–Ω—ç —Ñ—É–Ω–∫—Ü —É–¥–∞—Ö–≥“Ø–π –Ω—ç–º—ç–≥–¥—ç–Ω—ç.`);
    }

    // Load users
    async function loadUsers() {
      try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        console.log('Loading users with token:', token ? 'Token exists' : 'No token');

        const response = await fetch('http://localhost:5000/api/auth/admin/users', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || errorData.error || '–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞');
        }

        const data = await response.json();
        console.log('Users loaded:', data.users?.length || 0);
        allUsers = data.users || [];
        displayUsers(allUsers);
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 48px; color: #EF4444;">
              –ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Display users
    function displayUsers(users) {
      const tbody = document.getElementById('usersTableBody');

      if (!users || users.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 48px; color: var(--text-muted);">
              –•—ç—Ä—ç–≥–ª—ç–≥—á –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = users.map(user => {
        const date = new Date(user.created_at).toLocaleDateString('mn-MN');
        const fullName = `${user.last_name || ''} ${user.first_name || ''}`.trim() || '-';
        const isCurrentUser = user.id === UserManager.getUser()?.id;
        const isAdminUser = user.is_admin;

        return `
          <tr>
            <td>#${user.id}</td>
            <td style="font-weight: 600;">
              ${fullName}
              ${isAdminUser ? '<span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px;">ADMIN</span>' : ''}
            </td>
            <td>${user.email}</td>
            <td>${user.phone || '-'}</td>
            <td>${user.register_number || '-'}</td>
            <td>${date}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-secondary btn-icon" onclick="viewUserProfile(${user.id}, '${user.email}')">Profile</button>
                ${!isCurrentUser ? `<button class="btn btn-secondary btn-icon" style="background: #EF4444; border-color: #EF4444;" onclick="deleteUser(${user.id}, '${fullName}')">Delete</button>` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Filter users
    function filterUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase().trim();

      if (!searchTerm) {
        displayUsers(allUsers);
        return;
      }

      const filtered = allUsers.filter(user => {
        const fullName = `${user.last_name || ''} ${user.first_name || ''}`.toLowerCase();
        const email = (user.email || '').toLowerCase();
        const phone = (user.phone || '').toLowerCase();
        const register = (user.register_number || '').toLowerCase();

        return user.id.toString().includes(searchTerm) ||
               fullName.includes(searchTerm) ||
               email.includes(searchTerm) ||
               phone.includes(searchTerm) ||
               register.includes(searchTerm);
      });

      displayUsers(filtered);
    }

    // View user profile modal
    async function viewUserProfile(userId, userEmail) {
      try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/auth/admin/users`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          const user = data.users.find(u => u.id === userId);

          if (user) {
            const fullName = `${user.last_name || ''} ${user.first_name || ''}`.trim();
            const createdDate = new Date(user.created_at).toLocaleString('mn-MN');

            const profileInfo = `
üìã –•–≠–†–≠–ì–õ–≠–ì–ß–ò–ô–ù PROFILE

üë§ –ù—ç—Ä: ${fullName}
üìß –ò-–º—ç–π–ª: ${user.email || '-'}
üì± –£—Ç–∞—Å: ${user.phone || '-'}
üÜî –†–µ–≥–∏—Å—Ç—Ä: ${user.register_number || '-'}
üìç –•–∞—è–≥: ${user.address || '-'}
üìÖ –ë“Ø—Ä—Ç–≥“Ø“Ø–ª—Å—ç–Ω: ${createdDate}
üëë –ê–¥–º–∏–Ω —ç—Ä—Ö: ${user.is_admin ? '–¢–∏–π–º' : '“Æ–≥“Ø–π'}
            `.trim();

            alert(profileInfo);
          } else {
            alert('–•—ç—Ä—ç–≥–ª—ç–≥—á –æ–ª–¥—Å–æ–Ω–≥“Ø–π');
          }
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
        alert('–ê–ª–¥–∞–∞: –•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –º—ç–¥—ç—ç–ª–ª–∏–π–≥ –∞—á–∞–∞–ª–∂ —á–∞–¥—Å–∞–Ω–≥“Ø–π');
      }
    }

    // Delete user
    async function deleteUser(userId, userName) {
      if (!confirm(`–¢–∞ "${userName}" —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–≥ —É—Å—Ç–≥–∞—Ö–¥–∞–∞ –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?\n\n–≠–Ω—ç “Ø–π–ª–¥–ª–∏–π–≥ –±—É—Ü–∞–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π!`)) {
        return;
      }

      try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/auth/admin/users/${userId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || errorData.error || '–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞');
        }

        const data = await response.json();

        Utils.showToast(`${userName} –∞–º–∂–∏–ª—Ç—Ç–∞–π —É—Å—Ç–≥–∞–≥–¥–ª–∞–∞`, 'success');

        // –ñ–∞–≥—Å–∞–∞–ª—Ç—ã–≥ –¥–∞—Ö–∏–Ω –∞—á–∞–∞–ª–∞—Ö
        await loadUsers();
        await loadStatistics();

      } catch (error) {
        console.error('Error deleting user:', error);
        Utils.showToast('–ê–ª–¥–∞–∞: ' + error.message, 'error');
      }
    }

    // Load payments
    function loadPayments() {
      // Placeholder - will be implemented when payment API is ready
      document.getElementById('paymentsTableBody').innerHTML = `
        <tr>
          <td colspan="6" style="text-align: center; padding: 48px; color: var(--text-muted);">
            –¢”©–ª–±”©—Ä–∏–π–Ω —Ç“Ø“Ø—Ö –æ–¥–æ–æ–≥–æ–æ—Ä –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞
          </td>
        </tr>
      `;
    }

    // Filter payments
    function filterPayments() {
      // Placeholder
    }

    // Save settings
    function saveSettings() {
      alert('–¢–æ—Ö–∏—Ä–≥–æ–æ —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞!\n\n–≠–Ω—ç —Ñ—É–Ω–∫—Ü —É–¥–∞—Ö–≥“Ø–π –±“Ø—Ä—ç–Ω –∞–∂–∏–ª–ª–∞—Ö –±–æ–ª–Ω–æ.');
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        loadStatistics();
        loadLoans();
      });
    } else {
      loadStatistics();
      loadLoans();
    }
  </script>
</body>
</html>
