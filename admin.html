<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OmniCredit — Admin Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/navigation.css">
  <link rel="stylesheet" href="css/buttons.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/footer.css">

  <style>
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 48px 0;
      margin: -32px 0 32px;
      color: white;
      text-align: center;
    }

    .admin-tabs {
      display: flex;
      gap: 8px;
      margin: 32px 0;
      border-bottom: 2px solid var(--line);
      overflow-x: auto;
    }

    .admin-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-muted);
      transition: var(--transition);
      white-space: nowrap;
    }

    .admin-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .admin-tab:hover {
      color: var(--text);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
      margin: 32px 0;
    }

    .admin-stats-card {
      background: var(--card);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }

    .admin-stats-card h3 {
      font-size: 2rem;
      margin: 8px 0;
      background: var(--gradient-peachy);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .admin-stats-card p {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .data-table {
      width: 100%;
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .data-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background: var(--bg);
      padding: 16px;
      text-align: left;
      font-weight: 700;
      font-size: 0.875rem;
      color: var(--text-muted);
      border-bottom: 2px solid var(--line);
    }

    .data-table td {
      padding: 16px;
      border-bottom: 1px solid var(--line);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover {
      background: var(--bg);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-pending {
      background: #FFF4E6;
      color: #F59E0B;
    }

    .status-approved {
      background: #DFFFD8;
      color: #10b981;
    }

    .status-rejected {
      background: #FFE6E6;
      color: #EF4444;
    }

    .status-active {
      background: #E0F2FE;
      color: #0284C7;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      padding: 8px 12px;
      font-size: 0.875rem;
    }

    .search-box {
      margin: 24px 0;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .search-box input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--line);
      border-radius: var(--radius);
      font-size: 1rem;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--primary);
    }

    @media (max-width: 768px) {
      .data-table {
        overflow-x: auto;
      }

      .admin-tabs {
        padding-bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <div class="brand">OmniCredit Admin</div>
      <div class="nav-links">
        <a href="index.html">Нүүр</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="admin.html" class="active">Admin</a>
      </div>
      <div class="auth-buttons">
        <a href="profile.html" class="btn btn-ghost btn-sm">Профайл</a>
        <button class="btn btn-primary btn-sm" onclick="handleLogout()">Гарах</button>
      </div>
      <button class="mobile-menu-toggle">☰</button>
    </nav>

    <div class="admin-header">
      <h1>Admin Dashboard</h1>
      <p style="opacity: 0.9; margin-top: 8px;">Системийн удирдлагын самбар</p>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-grid">
      <div class="admin-stats-card">
        <p>Нийт хэрэглэгч</p>
        <h3 id="totalUsers">0</h3>
      </div>
      <div class="admin-stats-card">
        <p>Хүлээгдэж буй хүсэлт</p>
        <h3 id="pendingLoans">0</h3>
      </div>
      <div class="admin-stats-card">
        <p>Идэвхтэй зээл</p>
        <h3 id="activeLoans">0</h3>
      </div>
      <div class="admin-stats-card">
        <p>Нийт зээлийн дүн</p>
        <h3 id="totalLoanAmount">₮0</h3>
      </div>
    </div>

    <!-- Tabs -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('loans')">Зээлийн хүсэлт</button>
      <button class="admin-tab" onclick="switchTab('users')">Хэрэглэгчид</button>
      <button class="admin-tab" onclick="switchTab('payments')">Төлбөр</button>
      <button class="admin-tab" onclick="switchTab('settings')">Тохиргоо</button>
    </div>

    <!-- Loans Tab -->
    <div id="loans-tab" class="tab-content active">
      <div class="search-box">
        <input type="text" placeholder="Хайх (ID, нэр, дүн)..." id="loanSearch" onkeyup="filterLoans()">
        <select class="btn btn-secondary" id="loanStatusFilter" onchange="filterLoans()">
          <option value="all">Бүх төлөв</option>
          <option value="pending">Хүлээгдэж буй</option>
          <option value="approved">Зөвшөөрөгдсөн</option>
          <option value="rejected">Татгалзсан</option>
          <option value="active">Идэвхтэй</option>
        </select>
      </div>

      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Хэрэглэгч</th>
              <th>Дүн</th>
              <th>Хугацаа</th>
              <th>Төлөв</th>
              <th>Огноо</th>
              <th>Үйлдэл</th>
            </tr>
          </thead>
          <tbody id="loansTableBody">
            <tr>
              <td colspan="7" style="text-align: center; padding: 48px; color: var(--text-muted);">
                Ачааллаж байна...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
      <div class="search-box">
        <input type="text" placeholder="Хэрэглэгч хайх..." id="userSearch" onkeyup="filterUsers()">
      </div>

      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Нэр</th>
              <th>И-мэйл</th>
              <th>Утас</th>
              <th>Бүртгэсэн огноо</th>
              <th>Үйлдэл</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="6" style="text-align: center; padding: 48px; color: var(--text-muted);">
                Ачааллаж байна...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="payments-tab" class="tab-content">
      <div class="search-box">
        <input type="text" placeholder="Төлбөр хайх..." id="paymentSearch" onkeyup="filterPayments()">
      </div>

      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Зээлийн ID</th>
              <th>Хэрэглэгч</th>
              <th>Дүн</th>
              <th>Огноо</th>
              <th>Төлөв</th>
            </tr>
          </thead>
          <tbody id="paymentsTableBody">
            <tr>
              <td colspan="6" style="text-align: center; padding: 48px; color: var(--text-muted);">
                Төлбөрийн түүх одоогоор байхгүй байна
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <div class="card">
        <div class="card-body">
          <h3>Системийн тохиргоо</h3>
          <p style="color: var(--text-muted); margin: 16px 0;">Зээлийн үндсэн тохиргоо</p>

          <div style="margin: 24px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Хүүгийн хувь (%)</label>
            <input type="number" class="btn btn-secondary" style="width: 100%; padding: 12px;" placeholder="1.5" value="1.5">
          </div>

          <div style="margin: 24px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Хамгийн их зээлийн дүн (₮)</label>
            <input type="number" class="btn btn-secondary" style="width: 100%; padding: 12px;" placeholder="10000000" value="10000000">
          </div>

          <div style="margin: 24px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Хамгийн бага зээлийн дүн (₮)</label>
            <input type="number" class="btn btn-secondary" style="width: 100%; padding: 12px;" placeholder="100000" value="100000">
          </div>

          <button class="btn btn-primary btn-lg" onclick="saveSettings()">Хадгалах</button>
        </div>
      </div>
    </div>

  </div>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <div class="footer-brand">OmniCredit</div>
          <p>Монголын хамгийн хялбар бөгөөд найдвартай зээлийн үйлчилгээ.</p>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="footer-copyright">
          <span>© 2025 OmniCredit. Бүх эрх хуулиар хамгаалагдсан.</span>
        </div>
      </div>
    </div>
  </footer>

  <script src="js/utils.js"></script>
  <script src="js/navigation.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth-guard.js"></script>
  <script>
    let allLoans = [];
    let allUsers = [];
    let allPayments = [];

    // Logout handler
    function handleLogout() {
      if (confirm('Гарахдаа итгэлтэй байна уу?')) {
        AuthAPI.logout();
      }
    }

    // Tab switching
    function switchTab(tabName) {
      // Remove active class from all tabs
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Remove active class from all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // Add active class to clicked tab
      event.target.classList.add('active');

      // Show corresponding content
      document.getElementById(tabName + '-tab').classList.add('active');

      // Load data based on tab
      if (tabName === 'loans') loadLoans();
      else if (tabName === 'users') loadUsers();
      else if (tabName === 'payments') loadPayments();
    }

    // Load statistics
    async function loadStatistics() {
      try {
        // Load all loans
        const response = await fetch('http://localhost:5000/api/loans/admin/all', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        const data = await response.json();
        const loans = data.loans || [];

        // Load all users
        const usersResponse = await fetch('http://localhost:5000/api/auth/admin/users', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        const userData = await usersResponse.json();
        const users = userData.users || [];

        // Calculate statistics
        const pendingLoans = loans.filter(l => l.status === 'pending').length;
        const activeLoans = loans.filter(l => l.status === 'active' || l.status === 'approved').length;
        const totalAmount = loans.reduce((sum, l) => sum + (l.amount || 0), 0);

        // Update UI
        document.getElementById('totalUsers').textContent = users.length;
        document.getElementById('pendingLoans').textContent = pendingLoans;
        document.getElementById('activeLoans').textContent = activeLoans;
        document.getElementById('totalLoanAmount').textContent = `₮${totalAmount.toLocaleString()}`;

      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // Load loans
    async function loadLoans() {
      try {
        const response = await fetch('http://localhost:5000/api/loans/admin/all', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        const data = await response.json();
        allLoans = data.loans || [];
        displayLoans(allLoans);
      } catch (error) {
        console.error('Error loading loans:', error);
        document.getElementById('loansTableBody').innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 48px; color: #EF4444;">
              Алдаа гарлаа: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Display loans
    function displayLoans(loans) {
      const tbody = document.getElementById('loansTableBody');

      if (!loans || loans.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 48px; color: var(--text-muted);">
              Зээлийн хүсэлт байхгүй байна
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = loans.map(loan => {
        const statusClass = `status-${loan.status}`;
        const statusText = {
          'pending': 'Хүлээгдэж буй',
          'approved': 'Зөвшөөрөгдсөн',
          'rejected': 'Татгалзсан',
          'active': 'Идэвхтэй'
        }[loan.status] || loan.status;

        const date = new Date(loan.created_at).toLocaleDateString('mn-MN');

        return `
          <tr>
            <td>#${loan.id}</td>
            <td>${loan.user_id}</td>
            <td style="font-weight: 700;">₮${loan.amount.toLocaleString()}</td>
            <td>${loan.term} сар</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${date}</td>
            <td>
              <div class="action-buttons">
                ${loan.status === 'pending' ? `
                  <button class="btn btn-primary btn-icon" onclick="approveLoan(${loan.id})">Approve</button>
                  <button class="btn btn-secondary btn-icon" onclick="rejectLoan(${loan.id})">Reject</button>
                ` : `
                  <button class="btn btn-secondary btn-icon" onclick="viewLoanDetails(${loan.id})">View</button>
                `}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Filter loans
    function filterLoans() {
      const searchTerm = document.getElementById('loanSearch').value.toLowerCase();
      const statusFilter = document.getElementById('loanStatusFilter').value;

      let filtered = allLoans;

      // Filter by status
      if (statusFilter !== 'all') {
        filtered = filtered.filter(loan => loan.status === statusFilter);
      }

      // Filter by search term
      if (searchTerm) {
        filtered = filtered.filter(loan =>
          loan.id.toString().includes(searchTerm) ||
          loan.user_id.toString().includes(searchTerm) ||
          loan.amount.toString().includes(searchTerm)
        );
      }

      displayLoans(filtered);
    }

    // Approve loan
    async function approveLoan(loanId) {
      if (!confirm('Энэ зээлийг зөвшөөрөх үү?')) return;

      try {
        const response = await fetch(`http://localhost:5000/api/loans/admin/${loanId}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'approved' })
        });

        if (response.ok) {
          alert('Зээл амжилттай зөвшөөрөгдлөө');
          loadLoans();
          loadStatistics();
        } else {
          const error = await response.json();
          alert('Алдаа гарлаа: ' + (error.message || 'Тодорхойгүй алдаа'));
        }
      } catch (error) {
        console.error('Error approving loan:', error);
        alert('Алдаа гарлаа: ' + error.message);
      }
    }

    // Reject loan
    async function rejectLoan(loanId) {
      if (!confirm('Энэ зээлийг татгалзах уу?')) return;

      try {
        const response = await fetch(`http://localhost:5000/api/loans/admin/${loanId}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'rejected' })
        });

        if (response.ok) {
          alert('Зээл татгалзагдлаа');
          loadLoans();
          loadStatistics();
        } else {
          const error = await response.json();
          alert('Алдаа гарлаа: ' + (error.message || 'Тодорхойгүй алдаа'));
        }
      } catch (error) {
        console.error('Error rejecting loan:', error);
        alert('Алдаа гарлаа: ' + error.message);
      }
    }

    // View loan details
    function viewLoanDetails(loanId) {
      alert(`Зээлийн дэлгэрэнгүй мэдээлэл #${loanId}\n\nЭнэ функц удахгүй нэмэгдэнэ.`);
    }

    // Load users
    async function loadUsers() {
      try {
        const response = await fetch('http://localhost:5000/api/auth/admin/users', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        const data = await response.json();
        allUsers = data.users || [];
        displayUsers(allUsers);
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 48px; color: #EF4444;">
              Алдаа гарлаа: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Display users
    function displayUsers(users) {
      const tbody = document.getElementById('usersTableBody');

      if (!users || users.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 48px; color: var(--text-muted);">
              Хэрэглэгч байхгүй байна
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = users.map(user => {
        const date = new Date(user.created_at).toLocaleDateString('mn-MN');

        return `
          <tr>
            <td>#${user.id}</td>
            <td>${user.first_name} ${user.last_name}</td>
            <td>${user.email}</td>
            <td>${user.phone || '-'}</td>
            <td>${date}</td>
            <td>
              <button class="btn btn-secondary btn-icon" onclick="viewUserDetails(${user.id})">View</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Filter users
    function filterUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();

      const filtered = allUsers.filter(user =>
        user.id.toString().includes(searchTerm) ||
        (user.first_name + ' ' + user.last_name).toLowerCase().includes(searchTerm) ||
        user.email.toLowerCase().includes(searchTerm) ||
        (user.phone && user.phone.includes(searchTerm))
      );

      displayUsers(filtered);
    }

    // View user details
    function viewUserDetails(userId) {
      alert(`Хэрэглэгчийн дэлгэрэнгүй мэдээлэл #${userId}\n\nЭнэ функц удахгүй нэмэгдэнэ.`);
    }

    // Load payments
    function loadPayments() {
      // Placeholder - will be implemented when payment API is ready
      document.getElementById('paymentsTableBody').innerHTML = `
        <tr>
          <td colspan="6" style="text-align: center; padding: 48px; color: var(--text-muted);">
            Төлбөрийн түүх одоогоор байхгүй байна
          </td>
        </tr>
      `;
    }

    // Filter payments
    function filterPayments() {
      // Placeholder
    }

    // Save settings
    function saveSettings() {
      alert('Тохиргоо хадгалагдлаа!\n\nЭнэ функц удахгүй бүрэн ажиллах болно.');
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        loadStatistics();
        loadLoans();
      });
    } else {
      loadStatistics();
      loadLoans();
    }
  </script>
</body>
</html>
